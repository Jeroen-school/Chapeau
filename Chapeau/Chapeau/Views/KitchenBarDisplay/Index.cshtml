@model List<Chapeau.Models.Order>
@{
    if (ViewBag.Role.ToLower() == "kitchen")
    {
        ViewData["Title"] = "Kitchen";
    }
    else
    {
        ViewData["Title"] = "Bar";
    }
}

<div class="container py-4" id="kitchen-bar-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">@ViewBag.Role Display</h1>
    </div>

    <!-- Tabs -->
    @await Html.PartialAsync("_OrderTabs")
    <div class="row g-4 flex-grow-1" id="orders-container">
        @if (Model.Count > 0)
        {
            @await Html.PartialAsync("_OrdersPartial", Model)
        }
        else
        {
            <div class="d-flex justify-content-center align-items-center text-center w-100 flex-grow-1">
                <p class="text-muted">No orders at the moment.</p>
            </div>
        }
    </div>
</div>

@section Scripts {
    <!--SignalR script reference.-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <!--SignalR connection setup.-->
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/orderHub")
            .build();

         const currentStatus = "@Context.Request.Query["status"]"

        connection.start().catch(err => console.error(err.toString()));

        connection.on("ReceiveOrders", function () {
            // Fetch updated partial via AJAX and passing the status
            fetch(`/KitchenBarDisplay/OrdersPartial?status=${currentStatus}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById("orders-container").innerHTML = html;
                });
        });
        function UpdateOrderStatus(orderId, currentStatus) {
			// Prepare form data to send to the server
            const formData = new URLSearchParams();
            formData.append("orderId", orderId);
            formData.append("currentStatus", currentStatus);

            fetch('/KitchenBarDisplay/UpdateOrderStatus', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData.toString()
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to update status');
            })
            .catch(err => console.error(err));
        }
        function UpdateOrderCategoryStatus(orderId, category, currentStatus) {
            // Prepare form data to send to the server
            const formData = new URLSearchParams();
            formData.append("orderId", orderId);
            formData.append("category", category);
            formData.append("currentStatus", currentStatus);

            fetch('/KitchenBarDisplay/UpdateOrderCategoryStatus', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData.toString()
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to update status');
            })
            .catch(err => console.error(err));
        }
         function UpdateOrderItemStatus(orderId, orderItemId, currentStatus) {
            // Prepare form data to send to the server
            const formData = new URLSearchParams();
            formData.append("orderId", orderId);
            formData.append("orderItemId", orderItemId);
            formData.append("currentStatus", currentStatus);

            fetch('/KitchenBarDisplay/UpdateOrderItemStatus', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData.toString()
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to update status');
            })
            .catch(err => console.error(err));
        }
    </script>

}
